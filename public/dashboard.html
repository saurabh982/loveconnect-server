<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Messages Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.2em;
        }
        
        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.2em;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #ddd;
        }
        
        .server-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 0.9em;
            z-index: 1000;
        }
        
        .status-online {
            color: #4CAF50;
        }
        
        .status-offline {
            color: #f44336;
        }
        
        .dashboard-section {
            margin-bottom: 40px;
        }
        
        .dashboard-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .summary-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .big-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .sub-text {
            color: #888;
            font-size: 0.9em;
        }
        
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .app-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            position: relative;
        }
        
        .app-card.top-app {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        
        .app-rank {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .app-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.2em;
        }
        
        .app-package {
            color: #666;
            font-size: 0.8em;
            margin-bottom: 10px;
        }
        
        .app-usage {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .app-last-used {
            color: #888;
            font-size: 0.9em;
        }
        
        .usage-bar {
            background: #f0f0f0;
            height: 6px;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .usage-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }
        
        .card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .card .label {
            color: #888;
            font-size: 0.9em;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .app-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .app-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }
        
        .app-time {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .app-details {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .category-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .category-name {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .category-time {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .patterns-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .pattern-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .hourly-chart {
            display: flex;
            align-items: end;
            height: 150px;
            gap: 5px;
            margin-top: 15px;
        }
        
        .hour-bar {
            flex: 1;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 3px 3px 0 0;
            min-height: 5px;
            position: relative;
        }
        
        .hour-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            color: #666;
        }
        
        .device-info {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .device-info h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .device-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #667eea;
        }
        
        @media (max-width: 768px) {
            .patterns-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📱 Digital Wellbeing Dashboard</h1>
            <p>Comprehensive App Usage Analytics</p>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                🔄 Loading usage data...
            </div>
            
            <div id="dashboard" style="display: none;">
                <div id="deviceInfo" class="device-info"></div>
                
                <div class="summary-cards" id="summaryCards"></div>
                
                <div class="section">
                    <h2>📊 App Categories</h2>
                    <div class="category-grid" id="categoryGrid"></div>
                </div>
                
                <div class="section">
                    <h2>📱 Most Used Apps</h2>
                    <div class="apps-grid" id="appsGrid"></div>
                </div>
                
                <div class="section">
                    <h2>⏰ Usage Patterns</h2>
                    <div class="patterns-grid">
                        <div class="pattern-card">
                            <h3>Hourly App Launches</h3>
                            <div class="hourly-chart" id="hourlyChart"></div>
                        </div>
                        <div class="pattern-card">
                            <h3>Usage Summary</h3>
                            <div id="usageSummary"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="noData" class="no-data" style="display: none;">
                📱 No usage data available yet.<br>
                Make sure the "Love Messages" app is installed and has usage access permission.
            </div>
            
            <button class="refresh-btn" onclick="loadData()">🔄 Refresh Data</button>
        </div>
    </div>

    <script>
        let latestData = null;
        
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('noData').style.display = 'none';
                
                const response = await fetch('/usage_stats/latest');
                const data = await response.json();
                
                if (data && (data.usageData || data.usageStats)) {
                    latestData = data;
                    if (data.dataType === 'comprehensive' && data.usageData) {
                        displayComprehensiveDashboard(data);
                    } else {
                        displaySimpleDashboard(data);
                    }
                } else {
                    document.getElementById('noData').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('noData').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayComprehensiveDashboard(data) {
            const usageData = data.usageData;
            
            // Show dashboard
            document.getElementById('dashboard').style.display = 'block';
            
            // Display device info
            displayDeviceInfo(data.deviceInfo || {}, data.timestamp);
            
            // Display summary cards - enhanced for Digital Wellbeing
            displayDigitalWellbeingSummaryCards(usageData, data);
            
            // Display categories
            displayCategories(usageData.categoryBreakdown);
            
            // Display apps
            displayApps(usageData.apps);
            
            // Display patterns
            displayPatterns(usageData.usagePatterns);
            
            // Display notifications, calls, and messages if available
            if (data.dataType === 'digital_wellbeing') {
                displayNotifications(data.notifications);
                displayCalls(data.calls);
                displayMessages(data.messages);
            }
        }
        
        function displayDigitalWellbeingSummaryCards(usageData, data) {
            const container = document.getElementById('summaryCards');
            
            // Calculate additional statistics
            const notificationCount = Array.isArray(data.notifications) ? data.notifications.length : 0;
            const callCount = Array.isArray(data.calls) ? data.calls.length : 0;
            const messageCount = Array.isArray(data.messages) ? data.messages.length : 0;
            
            container.innerHTML = `
                <div class="card">
                    <h3>Screen Time Today</h3>
                    <div class="number">${usageData.totalScreenTimeHours || '0'}h</div>
                    <div class="label">${usageData.totalScreenTimeMinutes || 0} minutes</div>
                </div>
                <div class="card">
                    <h3>Apps Used</h3>
                    <div class="number">${usageData.totalAppsUsed || 0}</div>
                    <div class="label">Active today</div>
                </div>
                <div class="card">
                    <h3>App Launches</h3>
                    <div class="number">${usageData.usagePatterns?.totalAppLaunches || 0}</div>
                    <div class="label">Times opened</div>
                </div>
                <div class="card">
                    <h3>Most Used</h3>
                    <div class="number">${usageData.apps?.[0]?.appName?.substring(0, 10) || 'None'}${usageData.apps?.[0]?.appName?.length > 10 ? '...' : ''}</div>
                    <div class="label">${usageData.apps?.[0]?.usageDurationFormatted || '0m'}</div>
                </div>
                <div class="card">
                    <h3>Notifications</h3>
                    <div class="number">${notificationCount}</div>
                    <div class="label">Today</div>
                </div>
                <div class="card">
                    <h3>Calls</h3>
                    <div class="number">${callCount}</div>
                    <div class="label">Today</div>
                </div>
                <div class="card">
                    <h3>Messages</h3>
                    <div class="number">${messageCount}</div>
                    <div class="label">Today</div>
                </div>
                <div class="card">
                    <h3>Data Date</h3>
                    <div class="number">${usageData.dataDate || 'Today'}</div>
                    <div class="label">Updated: ${usageData.collectionTime || 'N/A'}</div>
                </div>
            `;
        }
        
        function displayNotifications(notifications) {
            if (!Array.isArray(notifications) || notifications.length === 0) return;
            
            const container = document.getElementById('appsGrid');
            
            // Add notifications section
            const notificationSection = document.createElement('div');
            notificationSection.className = 'section';
            notificationSection.innerHTML = `
                <h2>🔔 Notifications Today</h2>
                <div class="notifications-grid" id="notificationsGrid"></div>
            `;
            
            container.parentNode.insertBefore(notificationSection, container.nextSibling);
            
            const notificationsGrid = document.getElementById('notificationsGrid');
            
            // Group notifications by app
            const notificationsByApp = {};
            notifications.forEach(notification => {
                const appName = notification.appName || notification.packageName || 'Unknown';
                if (!notificationsByApp[appName]) {
                    notificationsByApp[appName] = [];
                }
                notificationsByApp[appName].push(notification);
            });
            
            // Display grouped notifications
            Object.entries(notificationsByApp).forEach(([appName, appNotifications]) => {
                const notificationCard = document.createElement('div');
                notificationCard.className = 'app-card';
                notificationCard.innerHTML = `
                    <div class="app-header">
                        <div class="app-name">${appName}</div>
                        <div class="app-time">${appNotifications.length} notifications</div>
                    </div>
                    <div class="notification-details">
                        ${appNotifications.slice(0, 3).map(notif => `
                            <div class="notification-item">
                                <div class="notification-time">${notif.time || 'N/A'}</div>
                                <div class="notification-title">${notif.title || 'No title'}</div>
                                <div class="notification-text">${(notif.text || '').substring(0, 100)}</div>
                            </div>
                        `).join('')}
                        ${appNotifications.length > 3 ? `<div class="more-notifications">+${appNotifications.length - 3} more</div>` : ''}
                    </div>
                `;
                notificationsGrid.appendChild(notificationCard);
            });
        }
        
        function displayCalls(calls) {
            if (!Array.isArray(calls) || calls.length === 0) return;
            
            const container = document.getElementById('appsGrid');
            
            const callSection = document.createElement('div');
            callSection.className = 'section';
            callSection.innerHTML = `
                <h2>📞 Calls Today</h2>
                <div class="calls-grid" id="callsGrid"></div>
            `;
            
            container.parentNode.insertBefore(callSection, container.nextSibling);
            
            const callsGrid = document.getElementById('callsGrid');
            
            calls.forEach(call => {
                const callCard = document.createElement('div');
                callCard.className = 'app-card';
                callCard.innerHTML = `
                    <div class="app-header">
                        <div class="app-name">${call.contactName || call.number || 'Unknown'}</div>
                        <div class="app-time">${call.type || 'Unknown'}</div>
                    </div>
                    <div class="call-details">
                        <div><strong>Number:</strong> ${call.number || 'N/A'}</div>
                        <div><strong>Time:</strong> ${call.timeFormatted || 'N/A'}</div>
                        <div><strong>Duration:</strong> ${call.durationFormatted || 'N/A'}</div>
                        <div><strong>Type:</strong> ${call.type || 'N/A'}</div>
                    </div>
                `;
                callsGrid.appendChild(callCard);
            });
        }
        
        function displayMessages(messages) {
            if (!Array.isArray(messages) || messages.length === 0) return;
            
            const container = document.getElementById('appsGrid');
            
            const messageSection = document.createElement('div');
            messageSection.className = 'section';
            messageSection.innerHTML = `
                <h2>💬 Messages Today</h2>
                <div class="messages-grid" id="messagesGrid"></div>
            `;
            
            container.parentNode.insertBefore(messageSection, container.nextSibling);
            
            const messagesGrid = document.getElementById('messagesGrid');
            
            messages.forEach(message => {
                const messageCard = document.createElement('div');
                messageCard.className = 'app-card';
                messageCard.innerHTML = `
                    <div class="app-header">
                        <div class="app-name">${message.contactName || message.address || 'Unknown'}</div>
                        <div class="app-time">${message.type || 'Unknown'}</div>
                    </div>
                    <div class="message-details">
                        <div><strong>From/To:</strong> ${message.address || 'N/A'}</div>
                        <div><strong>Time:</strong> ${message.timeFormatted || 'N/A'}</div>
                        <div><strong>Preview:</strong> ${(message.body || '').substring(0, 100)}</div>
                        <div><strong>Length:</strong> ${message.length || 0} chars</div>
                    </div>
                `;
                messagesGrid.appendChild(messageCard);
            });
        }
        
        function displaySimpleDashboard(data) {
            // Fallback for old simple format
            document.getElementById('dashboard').style.display = 'block';
            
            // Show basic info
            displayDeviceInfo({ model: data.device }, data.timestamp);
            
            // Process simple usage stats
            const appsWithUsage = (data.usageStats || [])
                .filter(app => app.totalTimeInForeground > 0)
                .map(app => ({
                    ...app,
                    appName: app.packageName.split('.').pop(),
                    category: 'Unknown',
                    usageDurationFormatted: formatDuration(app.totalTimeInForeground),
                    timeInMinutes: Math.round(app.totalTimeInForeground / (1000 * 60))
                }))
                .sort((a, b) => b.totalTimeInForeground - a.totalTimeInForeground);

            const totalUsage = appsWithUsage.reduce((sum, app) => sum + app.totalTimeInForeground, 0);
            
            const simpleUsageData = {
                totalScreenTime: totalUsage,
                totalScreenTimeFormatted: formatDuration(totalUsage),
                totalAppsUsed: appsWithUsage.length,
                apps: appsWithUsage,
                categoryBreakdown: {},
                usagePatterns: { totalAppLaunches: 0, hourlyUsage: [] }
            };
            
            displaySummaryCards(simpleUsageData);
            displayCategories({});
            displayApps(appsWithUsage);
            displayPatterns({ totalAppLaunches: 0, hourlyUsage: [] });
        }
        
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ${hours % 24}h ${minutes % 60}m`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m`;
            return `${seconds}s`;
        }
        
        function displayDeviceInfo(deviceInfo, timestamp) {
            const container = document.getElementById('deviceInfo');
            const lastUpdate = new Date(timestamp).toLocaleString();
            
            container.innerHTML = `
                <h3>📱 Device Information</h3>
                <div class="device-details">
                    <div><strong>Device:</strong> ${deviceInfo.brand} ${deviceInfo.model}</div>
                    <div><strong>Android:</strong> ${deviceInfo.androidVersion} (API ${deviceInfo.sdkVersion})</div>
                    <div><strong>Last Update:</strong> ${lastUpdate}</div>
                    <div><strong>Data Period:</strong> Last 24 hours</div>
                </div>
            `;
        }
        
        function displaySummaryCards(usageData) {
            const container = document.getElementById('summaryCards');
            
            container.innerHTML = `
                <div class="card">
                    <h3>Total Screen Time</h3>
                    <div class="number">${usageData.totalScreenTimeFormatted || '0m'}</div>
                    <div class="label">Last 24 hours</div>
                </div>
                <div class="card">
                    <h3>Apps Used</h3>
                    <div class="number">${usageData.totalAppsUsed || 0}</div>
                    <div class="label">Different apps</div>
                </div>
                <div class="card">
                    <h3>App Launches</h3>
                    <div class="number">${usageData.usagePatterns?.totalAppLaunches || 0}</div>
                    <div class="label">Total opens</div>
                </div>
                <div class="card">
                    <h3>Most Used</h3>
                    <div class="number">${usageData.apps?.[0]?.appName?.substring(0, 10) || 'None'}${usageData.apps?.[0]?.appName?.length > 10 ? '...' : ''}</div>
                    <div class="label">${usageData.apps?.[0]?.usageDurationFormatted || '0m'}</div>
                </div>
            `;
        }
        
        function displayCategories(categoryBreakdown) {
            const container = document.getElementById('categoryGrid');
            
            if (!categoryBreakdown) {
                container.innerHTML = '<div class="no-data">No category data available</div>';
                return;
            }
            
            const categories = Object.entries(categoryBreakdown)
                .sort(([,a], [,b]) => b.totalTime - a.totalTime)
                .slice(0, 8);
            
            container.innerHTML = categories.map(([name, data]) => `
                <div class="category-card">
                    <div class="category-name">${name}</div>
                    <div class="category-time">${data.formattedTime}</div>
                </div>
            `).join('');
        }
        
        function displayApps(apps) {
            const container = document.getElementById('appsGrid');
            
            if (!apps || apps.length === 0) {
                container.innerHTML = '<div class="no-data">No app data available</div>';
                return;
            }
            
            const topApps = apps.slice(0, 12);
            
            container.innerHTML = topApps.map(app => `
                <div class="app-card">
                    <div class="app-header">
                        <div class="app-name">${app.appName}</div>
                        <div class="app-time">${app.usageDurationFormatted}</div>
                    </div>
                    <div class="app-details">
                        <div><strong>Category:</strong> ${app.category}</div>
                        <div><strong>Last Used:</strong> ${new Date(app.lastTimeUsed).toLocaleString()}</div>
                        <div><strong>Package:</strong> ${app.packageName}</div>
                        <div><strong>Events:</strong> ${app.usageEvents?.length || 0} recorded</div>
                    </div>
                </div>
            `).join('');
        }
        
        function displayPatterns(patterns) {
            const hourlyContainer = document.getElementById('hourlyChart');
            const summaryContainer = document.getElementById('usageSummary');
            
            if (!patterns || !patterns.hourlyUsage) {
                hourlyContainer.innerHTML = '<div class="no-data">No pattern data available</div>';
                summaryContainer.innerHTML = '<div class="no-data">No summary available</div>';
                return;
            }
            
            // Hourly chart
            const maxLaunches = Math.max(...patterns.hourlyUsage.map(h => h.appLaunches));
            
            hourlyContainer.innerHTML = patterns.hourlyUsage.map(hour => {
                const height = maxLaunches > 0 ? (hour.appLaunches / maxLaunches) * 140 : 5;
                return `
                    <div class="hour-bar" style="height: ${height}px" title="${hour.hour}:00 - ${hour.appLaunches} launches">
                        <div class="hour-label">${hour.hour}</div>
                    </div>
                `;
            }).join('');
            
            // Usage summary
            const peakHour = patterns.hourlyUsage.reduce((peak, current) => 
                current.appLaunches > peak.appLaunches ? current : peak
            );
            
            summaryContainer.innerHTML = `
                <div style="margin-bottom: 15px;"><strong>📊 Peak Usage:</strong> ${peakHour.hour}:00 (${peakHour.appLaunches} launches)</div>
                <div style="margin-bottom: 15px;"><strong>🎯 Total Launches:</strong> ${patterns.totalAppLaunches}</div>
                <div><strong>📈 Average per Hour:</strong> ${Math.round(patterns.totalAppLaunches / 24)} launches</div>
            `;
        }
        
        // Load data on page load
        loadData();
        
        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>
            font-weight: bold;
            color: #2196F3;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .app-item {
            background: #fff;
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #45a049;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📱 Usage Agent Dashboard</h1>
        
        <div class="status" id="status">
            <strong>Server Status:</strong> <span id="serverStatus">Checking...</span>
        </div>

        <button class="refresh-btn" onclick="loadData()">🔄 Refresh Data</button>

        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <h3>Total Submissions</h3>
                <div class="number" id="totalSubmissions">-</div>
            </div>
            <div class="stat-card">
                <h3>Devices</h3>
                <div class="number" id="totalDevices">-</div>
            </div>
            <div class="stat-card">
                <h3>Last Received</h3>
                <div class="number" id="lastReceived">-</div>
            </div>
        </div>

        <div id="dataContainer">
            <div class="loading">Loading data...</div>
        </div>
    </div>

    <script>
        let serverUrl = 'http://localhost:3000';

        async function checkServerStatus() {
            try {
                const response = await fetch(serverUrl);
                if (response.ok) {
                    document.getElementById('serverStatus').textContent = '✅ Online';
                    document.getElementById('serverStatus').style.color = '#4CAF50';
                } else {
                    throw new Error('Server responded with error');
                }
            } catch (error) {
                document.getElementById('serverStatus').textContent = '❌ Offline';
                document.getElementById('serverStatus').style.color = '#f44336';
            }
        }

        async function loadData() {
            try {
                const response = await fetch(`${serverUrl}/usage_stats`);
                const data = await response.json();
                
                // Update stats
                document.getElementById('totalSubmissions').textContent = data.total || 0;
                
                const devices = new Set();
                let lastReceived = 'Never';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(entry => devices.add(entry.device));
                    
                    const latest = data.data[data.data.length - 1];
                    lastReceived = new Date(latest.receivedAt).toLocaleString();
                }
                
                document.getElementById('totalDevices').textContent = devices.size;
                document.getElementById('lastReceived').textContent = lastReceived;
                
                // Render data table
                renderDataTable(data.data || []);
                
            } catch (error) {
                document.getElementById('dataContainer').innerHTML = 
                    `<div class="loading">Error loading data: ${error.message}</div>`;
            }
        }

        function renderDataTable(data) {
            if (data.length === 0) {
                document.getElementById('dataContainer').innerHTML = 
                    '<div class="loading">No data received yet. Send some data from your Android app!</div>';
                return;
            }

            // Get the latest data entry for detailed analysis
            const latestData = data[data.length - 1];
            
            // Process apps with usage time
            const appsWithUsage = latestData.usageStats
                .filter(app => app.totalTimeInForeground > 0)
                .map(app => ({
                    ...app,
                    timeInMinutes: Math.round(app.totalTimeInForeground / (1000 * 60)),
                    timeInHours: (app.totalTimeInForeground / (1000 * 60 * 60)).toFixed(1),
                    lastUsed: app.lastTimeUsed ? new Date(app.lastTimeUsed).toLocaleString() : 'Never'
                }))
                .sort((a, b) => b.totalTimeInForeground - a.totalTimeInForeground);

            const totalUsageTime = appsWithUsage.reduce((sum, app) => sum + app.totalTimeInForeground, 0);
            const totalHours = (totalUsageTime / (1000 * 60 * 60)).toFixed(1);

            let html = `
                <div class="dashboard-section">
                    <h2>� Device Usage Summary</h2>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <h3>Total Screen Time</h3>
                            <div class="big-number">${totalHours}h</div>
                            <div class="sub-text">Today</div>
                        </div>
                        <div class="summary-card">
                            <h3>Apps Used</h3>
                            <div class="big-number">${appsWithUsage.length}</div>
                            <div class="sub-text">Active apps</div>
                        </div>
                        <div class="summary-card">
                            <h3>Device</h3>
                            <div class="big-number">${latestData.device}</div>
                            <div class="sub-text">Samsung Galaxy A50</div>
                        </div>
                        <div class="summary-card">
                            <h3>Last Update</h3>
                            <div class="big-number">${new Date(latestData.receivedAt).toLocaleTimeString()}</div>
                            <div class="sub-text">${new Date(latestData.receivedAt).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section">
                    <h2>🏆 Top Apps by Usage Time</h2>
                    <div class="apps-grid">
            `;

            // Show top 10 apps
            appsWithUsage.slice(0, 10).forEach((app, index) => {
                const percentage = ((app.totalTimeInForeground / totalUsageTime) * 100).toFixed(1);
                const appName = app.packageName.split('.').pop().replace(/[^a-zA-Z0-9]/g, '');
                
                html += `
                    <div class="app-card ${index < 3 ? 'top-app' : ''}">
                        <div class="app-rank">#${index + 1}</div>
                        <div class="app-info">
                            <h4>${appName}</h4>
                            <div class="app-package">${app.packageName}</div>
                            <div class="app-usage">${app.timeInHours}h (${percentage}%)</div>
                            <div class="app-last-used">Last used: ${app.lastUsed}</div>
                        </div>
                        <div class="usage-bar">
                            <div class="usage-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>

                <div class="dashboard-section">
                    <h2>📊 All Data Submissions</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Received At</th>
                                <th>Total Apps</th>
                                <th>Active Apps</th>
                                <th>Screen Time</th>
                                <th>Top App</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.reverse().forEach(entry => {
                const receivedAt = new Date(entry.receivedAt).toLocaleString();
                const activeApps = entry.usageStats.filter(app => app.totalTimeInForeground > 0);
                const totalTime = activeApps.reduce((sum, app) => sum + app.totalTimeInForeground, 0);
                const totalHours = (totalTime / (1000 * 60 * 60)).toFixed(1);
                const topApp = activeApps.sort((a, b) => b.totalTimeInForeground - a.totalTimeInForeground)[0];
                const topAppName = topApp ? topApp.packageName.split('.').pop() : 'None';

                html += `
                    <tr>
                        <td><strong>${entry.device}</strong></td>
                        <td>${receivedAt}</td>
                        <td>${entry.usageStats.length}</td>
                        <td>${activeApps.length}</td>
                        <td>${totalHours}h</td>
                        <td>${topAppName}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('dataContainer').innerHTML = html;
        }

        // Initialize
        checkServerStatus();
        loadData();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            checkServerStatus();
            loadData();
        }, 30000);
    </script>
</body>
</html>
